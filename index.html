<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التقاط صورة تلقائياً من الكاميرا الأمامية</title>
</head>
<body>
  <h3>التقاط صورة من الكاميرا الأمامية</h3>
  <p id="status">جاري التحضير...</p>

  <!-- فيديو لعرض الكاميرا (يمكن إخفاءه إذا رغبت) -->
  <video id="video" autoplay playsinline style="width:100%;max-width:400px;display:block"></video>

  <!-- مكان لإظهار الصورة الملتقطة -->
  <img id="photo" alt="الصورة الملتقطة" style="width:100%;max-width:400px;display:none;margin-top:8px" />

  <script>
    (async () => {
      const status = document.getElementById('status');
      const video = document.getElementById('video');
      const photo = document.getElementById('photo');

      // شرط: الموقع يعمل عبر HTTPS (أو localhost أثناء التطوير)
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        status.textContent = 'ملاحظة: يلزم تشغيل الصفحة عبر HTTPS حتى تعمل الكاميرا.';
        // لا نستمر إذا ليس HTTPS (يمكن إزالة هذا السطر أثناء التطوير على localhost)
        // return;
      }

      try {
        // نطلب media stream مع الكاميرا الأمامية (facingMode: "user")
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });

        // عرض الفيديو
        video.srcObject = stream;
        status.textContent = 'الرجاء السماح بالكاميرا إذا طُلب.';

        // عندما يبدأ الفيديو باللعب، نأخذ لقطة
        video.addEventListener('loadedmetadata', () => {
          // ننتظر حتى يظهر أول إطار
          video.play();
        });

        video.addEventListener('playing', async () => {
          status.textContent = 'التقاط الصورة الآن...';

          // نضع الصورة على canvas
          const canvas = document.createElement('canvas');
          canvas.width = video.videoWidth || 1280;
          canvas.height = video.videoHeight || 720;
          const ctx = canvas.getContext('2d');

          // مرآة للصورة الأمامية (اختياري): تعكس المحور X حتى تظهر كما في الكاميرا الأمامية
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // نعرض الصورة للمستخدم
          photo.src = canvas.toDataURL('image/jpeg', 0.9);
          photo.style.display = 'block';

          status.textContent = 'تم التقاط الصورة.';

          // إيقاف كل مسارات الفيديو لقطع الوصول للكاميرا
          stream.getTracks().forEach(t => t.stop());

          // --- مثال: رفع الصورة للسيرفر (اختياري) ---
          // const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.9));
          // const fd = new FormData();
          // fd.append('photo', blob, 'selfie.jpg');
          // await fetch('/upload', { method: 'POST', body: fd });
          // status.textContent = 'تم رفع الصورة للسيرفر.';
        }, { once: true });

      } catch (err) {
        console.error(err);
        status.textContent = 'فشل الوصول للكاميرا: ' + (err.message || err.name);
        // كبديل للمتصفحات القديمة (أو إن رفض المستخدم)، يمكنك إظهار input file:
        // <input type="file" accept="image/*" capture="user">
      }
    })();
  </script>
</body>
</html>
